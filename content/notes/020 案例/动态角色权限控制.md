---
created: 2022-06-19
tags: RLS 
subject: 
importance: 5
skilled: 4
status:
author:
url:
https://www.wolai.com/muxiaoqi/n7nGNKkPmQobfjFDGQRz8W
cover: 
---

### 构建角色权限表

包含角色的邮箱、权限

![](https://secure2.wostatic.cn/static/d3wyAozR1QgHg6TdRUpPQQ/image.png?auth_key=1655627766-2xTmKKno7VzkQFrZBYyzYo-0-a4bd74749aa372848ba40e424c787200)

### 新建角色

![](https://secure2.wostatic.cn/static/8FXQLyV2REi46ue1vJKHRh/image.png?auth_key=1655627775-kNw8v6b3jbnA1rD8CrweHH-0-bfe7a344b213fdf94dc46c1cf461bf57)

这里只需要创建一个角色，以DimCity表为例，有些人的权限是只到省份，有些人的是到城市，还有一点

需要特别注意的就是权限表中若没有写某字段的权限，则应是该字段不受权限控制，而不是没有该字段的权限。

以陈晓飞为例，他应该看的是全国市场下药品信息表中的这些数据。

![](https://secure2.wostatic.cn/static/jb98An6ntwU5jdF9iiG5HN/image.png?auth_key=1655627783-idonkM3jexQedDz8yEq2rF-0-9c41461f6dda601548ff9dabcfdf4015)

代码思路也很简单

-   先从权限表中获取该用户该字段的权限，然后生成一张表
-   上面生成的表如果为空，则该字段不需要被控制，否则只显示上述表中的值
-   同一张表若有多个字段需要控制，则为或的关系

```js
VAR RlsProvince = FILTER('RLS2','RLS2'[ID] = USERNAME() && 'RLS2'[RLS] = "地区-省份")
VAR CurProvince = CALCULATETABLE( VALUES('RLS2'[拥有权限]),RlsProvince )
RETURN
  IF( ISEMPTY( CurProvince ), TRUE(), [ProvinceName] IN CurProvince )
||
VAR RlsCity = FILTER( 'RLS2','RLS2'[ID] = USERNAME() &&'RLS2'[RLS] = "地区-城市" )
VAR CurCity = CALCULATETABLE( VALUES('RLS2'[拥有权限]), RlsCity )
RETURN
  IF( ISEMPTY( CurCity ), TRUE(), [CityName] IN CurCity )
```

## 其他

如果权限表中没有的则代表没有该权限，则设置会更简单些，可直接参考如下

```js
是否拥有城市权限城市 =
VAR AccessItemName = SELECTEDVALUE('用户城市权限'[城市名称])
VAR AccessItemType = "西安市"
VAR CurrentUserAccessTable = 
FILTER('用户城市权限','用户城市权限'[用户名称] = USERNAME() && '用户城市权限'[城市名称] = AccessItemType)
VAR CurrentUserAccessItems = 
CALCULATETABLE(VALUES('用户城市权限'[城市名称]),CurrentUserAccessTable)
RETURN AccessItemName IN CurrentUserAccessIte
```