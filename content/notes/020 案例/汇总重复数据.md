---
created: 2022-06-19
tags: 汇总 聚合
subject:
importance: 3
skilled: 3
status:
author:
url: https://www.wolai.com/muxiaoqi/og987nuLK7BdDh3TeJnF93
cover: 
---

做过DAX性能优化的应该都知道，在做优化时有一个很常用的方法就是先聚合后迭代，这样当表的基数很大时，可以几何倍的减少迭代次数。虽然今天这个例子与性能优化无关，却也是应用的这种思路。

先来看下数据，value列存的是每个group的总值，也就说A的总值就是10。

![](https://secure2.wostatic.cn/static/me3C5QvYqYZovfbE9qux6T/image.png?auth_key=1655634540-cXzmPKkk2SFS7PGdp5BYfB-0-727d077091a4a82d1c611eda7973824a)

如果我们还是按常规的方式计算Value，总计就会是140，事实上总计应该是10+15+20+10=55

```js
value (error) = SUM( '表'[value])
```

![image.png (566×407) (wostatic.cn)](https://secure2.wostatic.cn/static/5vdybqW7HVSNk1b4oPCiTk/image.png?auth_key=1655993759-5Ku8Jwjs7y2y97jkmAi5mD-0-23b2f8e5c0496a4eea038469213e3c82)

前面已经介绍过了性能优化时常用的一个思路，放到这里其实是需要对数据去重

-   先按group进行聚合，然后增加@value列，
-   在计算MAX('表'[value] )时，外层需要包上[[CALCULATE#语法]]进行上下文转换
-   最后对生成的中间进行迭代汇总计算

```js
Value = 
var GroupValue = 
ADDCOLUMNS(
    SUMMARIZE(
        '表',
        '表'[group]
    ),
    "@value", CALCULATE( MAX( '表'[value] ) )
)
var Result = SUMX( GroupValue, [@value] )
return Result
```

效果如下

![image.png (576×336) (wostatic.cn)](https://secure2.wostatic.cn/static/koPeZVgM8Hp2orz3Ckakzo/image.png?auth_key=1655993770-9kUBB1GffF8v6RKQttQCUR-0-d549971a33c7c58e3ef530482d011f33)

这个例子很简单，但可能在第一次写的时候陷入误区，但仔细想想理清思路，代码写出来又会发现其实很简单。这也是为什么我在带人时，时常说先别急着做，先倒推下为了得出结果需要什么，然后把需要的通过变量的方式，一步步算出来就好。其实看到这个例子中的数据时，让我想到的是另一类案例，做过预算分解的人或者目标分解的应该会觉得很眼熟，因为目标表通常也是只到年或者月，比如下面这个例子

![image.png (231×153) (wostatic.cn)](https://secure2.wostatic.cn/static/efcZNrkhtScx7AXEW7Wona/image.png?auth_key=1655993778-ci5ydA3icdg7a3msTqL2Zv-0-e9de30ed5cdf18abec5c8428d3ecdf23)

![image.png (673×291) (wostatic.cn)](https://secure2.wostatic.cn/static/m2WYB9kuZnnbiroQ4Bgm4t/image.png?auth_key=1655993786-sD8FvPn1PfzYT7PbC9Tj4b-0-0f690ddd8d6d12ea56e455e6e139ea32)

这个计算更相对更简单了，只需计算时在Date表和Plan表之间使用虚拟关系即可

```js
Plan = CALCULATE ( SUM( 'Plan'[Plan] ), TREATAS( VALUES( 'Plan'[Year]),'Date'[Year] ))
```

然后再根据具体的业务逻辑看怎么拆分到月或者日就好。

这也是使用笔记工具记录知识以来最大的一个感触，每一次新知识的获取，都会对已有知识进行一次关联重组，这也是为什么近几年双链笔记软件这么盛行的原因，确实可以有效的帮助我这样不怎么聪明，又不怎么擅长整理的人。