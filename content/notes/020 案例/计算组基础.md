---
created: 2022-06-19
tags: 计算组 字符格式化 
subject: 计算组
importance: 5
skilled: 5
status:
author:
url: https://www.wolai.com/muxiaoqi/3sBuxv9ZpZ2qg76Bn8pxBQ
cover: 
---

![](https://secure2.wostatic.cn/static/v5ATNueXWcZdwiRs613tQd/image.png?auth_key=1655636557-9TjyZJhBS6dSoC8kG7XfDT-0-e749f4deb88f468a347c9be2313c7d6b)

### CY

```js
SELECTEDMEASURE ()
```

### PY

```js
CALCULATE (
    SELECTEDMEASURE (),
    SAMEPERIODLASTYEAR ( 'Date'[Date] )
)
```

### QTD

```js
CALCULATE (
    SELECTEDMEASURE (),
    DATESQTD ( 'Date'[Date] )
)
```

### YTD

```js
CALCULATE (
    SELECTEDMEASURE (),
    DATESYTD ( 'Date'[Date] )
)
```

可以在报告中写如下度量

### YTD

```js
CR YTD = 
CALCULATE (
    DIVIDE (
        [Total Cost],
        [Sales Amount]
    ),
    'Time Intelligence'[Time calc] = "YTD"
)
```

## 单价和成本价切换

![image.png (802×373) (wostatic.cn)](https://secure2.wostatic.cn/static/9NrznY7HtzJTDj4ms3wWrc/image.png?auth_key=1655993883-mPj9ixKEkUfzPeeJmtN8bA-0-7c2f1bf1b8badd11dc1eeeffe129986e)

这里会有一个容易犯错的地方，我们先创建计算组所需要的两个度量

```js
SUMX ( Sales, Sales[Quantity] * Sales[Net Price] )

```

```js
SUMX ( Sales, Sales[Quantity] * Sales[Unit Price] )
```

![image.png (749×291) (wostatic.cn)](https://secure2.wostatic.cn/static/482CJeJZGnYP3KCQ43xfSJ/image.png?auth_key=1655993892-cnNvK3TCPpnEYKYU3KJ3sK-0-d123dc6a3956dfe6ac213a30fdace69d)

这时候如果我们直接页面上筛选的话，数据会有问题，会发现所有的度量值都补替换成了Unit Price，

![image.png (872×393) (wostatic.cn)](https://secure2.wostatic.cn/static/uFUikP4kD11kJP5wYKCUUX/image.png?auth_key=1655993995-ixskc7veAoxRw9eqJWqBWX-0-6c76019d7f194518d0b6637dab34f849)

如何解决上面这个问题呢，我们可以再创建一张表

![image.png (637×235) (wostatic.cn)](https://secure2.wostatic.cn/static/u9a9QUa5MjShWs6VnpDyjK/image.png?auth_key=1655994004-5zFYKzjtwiCnm6JURo86Zb-0-5adda06005a29b21fe589267dc2aef64)

通过这张表来和计算组的表相关联，修改Sales Amount如下

```js
Sales Amount = 
CALCULATE (
    [Internal Sales Amount],
    TREATAS ( DISTINCT ( PriceToUse[PriceToUse] ), InternalPriceToUse[InternalPriceToUse] )
)


// IF ( 
//     SELECTEDVALUE ( PriceToUse[PriceToUse] ) = "Net Price",
//     SUMX ( Sales, Sales[Quantity] * Sales[Net Price] ),
//     SUMX ( Sales, Sales[Quantity] * Sales[Unit Price] )
// )
```

### 切换货币

-   默认货币是USD
-   过虑不需要格式化的度量

```js
CALCULATE (
    VAR SelectedCurrency =
        SELECTEDVALUE ( 'Currency'[Currency Code], "USD" )
    VAR MeasureName = 
        SELECTEDVALUE ( 
            Metric[Metric], 
            SELECTEDMEASURENAME() 
        ) 
    VAR SkipConversion = 
    (SEARCH ( "#", MeasureName, 1, 0 ) > 0) || (SEARCH ( "%", MeasureName, 1, 0 ) > 0)
    RETURN 
        IF (
            SkipConversion || SelectedCurrency = "USD",
            SELECTEDMEASURE (),
            -- Single Currency non-US selected
            VAR DatesExchange =
                ADDCOLUMNS (
                    SUMMARIZE ( ExchangeRate, 'Date'[Calendar Year Month Number] ),
                    "ExchangeAverageRate", CALCULATE ( VALUES ( 'ExchangeRate'[AverageRate] ) )
                )
            VAR Result =
                SUMX ( DatesExchange, SELECTEDMEASURE () * [ExchangeAverageRate] )
            RETURN
                Result
        ),
    CROSSFILTER ( Sales[CurrencyKey], 'Currency'[CurrencyKey], NONE )
) 

```

![image.png (1061×495) (wostatic.cn)](https://secure2.wostatic.cn/static/dh63petVmN2rNdzEeGypix/image.png?auth_key=1655994030-T5Kc238zZd1kf57tagFS9-0-e12b917872e1674c964d254c0e483638)

## 自动切换单位

![image.png (855×358) (wostatic.cn)](https://secure2.wostatic.cn/static/7YYsCTuPgiNM1EAFrP4hnr/image.png?auth_key=1655994038-ncZoS9SveggDtYjkhkCPuc-0-738cd3755db015a5b5d16cd34af70ec8)
可以选择要显示的单位是中文还是英文，数值导出时还是无单位的原数据，

```js
VAR V = ABS( SELECTEDMEASURE () )
VAR N = SELECTEDVALUE('En or Cn'[Name], "CN")
RETURN
IF( N = "EN",
    SWITCH (
        TRUE (),
        V >= 1E10, "0,,,.0G",
        V >= 1E9, "0,,,.00G",
        V >= 1E8, "0,,.M",
        V >= 1E7, "0,,.0M",
        V >= 1E6, "0,,.00M",
        V >= 1E5, "0,.k",
        V >= 1E4, "0,.0k",
        V >= 1E3, "0,.00k",
        V >= 1E2, "0.",
        V >= 1E1, "0.0",
        V >= 1E0, "0.00",
        "#,0.00%"
     ),
     SWITCH (
        TRUE (),
        V >= 1E10, "0,,,.0亿",
        V >= 1E9, "0,,,.00亿",
        V >= 1E8, "0,,.百万",
        V >= 1E7, "0,,.百万",
        V >= 1E6, "0,,.00百万",
        V >= 1E5, "0,.千",
        V >= 1E4, "0,.0千",
        V >= 1E3, "0,.00千",
        V >= 1E2, "0.",
        V >= 1E1, "0.0",
        V >= 1E0, "0.00",
        "#,0.00%"
     )
)
```